<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tecido 3D Personalizável</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; touch-action: none; }
        
        #info {
            position: absolute;
            top: 20px;
            width: 100%;
            text-align: center;
            color: #ccc;
            pointer-events: none;
            text-shadow: 1px 1px 2px black;
            font-size: 14px;
            letter-spacing: 1px;
            z-index: 10;
        }
        
        /* Botão de Configurações (Engrenagem) */
        #btn-settings {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            cursor: pointer;
            z-index: 30;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            transition: transform 0.2s, background 0.2s;
        }

        #btn-settings:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        #btn-settings svg {
            width: 24px;
            height: 24px;
            fill: #fff;
        }

        /* Painel de Configurações */
        #settings-panel {
            display: none; /* Oculto por padrão */
            position: absolute;
            top: 80px;
            left: 20px;
            width: 280px;
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid #444;
            border-radius: 12px;
            padding: 20px;
            z-index: 40;
            color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .close-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 20px;
            cursor: pointer;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #aaa;
        }

        /* Inputs */
        input[type="color"] {
            width: 100%;
            height: 40px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: none;
        }

        input[type="file"] {
            width: 100%;
            font-size: 12px;
            color: #ccc;
        }

        input[type="file"]::file-selector-button {
            background: #4db8ff;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            margin-right: 10px;
            transition: background 0.2s;
        }

        input[type="file"]::file-selector-button:hover {
            background: #7eccff;
        }

        .remove-tex-btn {
            background: #ff4d4d;
            border: none;
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            margin-top: 5px;
            font-size: 12px;
            display: none; /* Aparece só quando tem textura */
        }

        /* Estilização dos Botões Touch (Mobile) */
        .touch-btn {
            position: absolute;
            bottom: 40px;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            text-align: center;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            z-index: 20;
            backdrop-filter: blur(5px);
        }

        .touch-btn:active, .touch-btn.active {
            background: rgba(77, 184, 255, 0.6);
            scale: 0.95;
            border-color: #4db8ff;
        }

        #btn-grab { left: 30px; }
        #btn-rotate { right: 30px; }

        b { color: #4db8ff; }
    </style>
</head>
<body>

    <div id="info">
        <b>MODO MOBILE:</b> Use os botões inferiores<br>
        <b>DESKTOP:</b> Botão Esquerdo (Agarrar) | Direito (Girar)
    </div>

    <!-- Botão de Configurações -->
    <div id="btn-settings" title="Configurações">
        <svg viewBox="0 0 24 24">
            <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
        </svg>
    </div>

    <!-- Painel de Configurações -->
    <div id="settings-panel">
        <div class="panel-header">
            <span>Personalizar Tecido</span>
            <button class="close-btn" id="close-settings">×</button>
        </div>
        
        <div class="control-group">
            <label>Cor do Tecido</label>
            <input type="color" id="color-picker" value="#2244ff">
        </div>

        <div class="control-group">
            <label>Estampa (Upload de Imagem)</label>
            <input type="file" id="texture-upload" accept="image/*">
            <button id="remove-texture" class="remove-tex-btn">Remover Estampa</button>
        </div>
    </div>

    <!-- Botões Virtuais -->
    <div id="btn-grab" class="touch-btn">AGARRAR</div>
    <div id="btn-rotate" class="touch-btn">GIRAR</div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- Configurações de Física ---
        const DAMPING = 0.96;       
        const MASS = 0.15;           
        const GRAVITY = 981 * 1.2;  
        const TIMESTEP = 18 / 1000; 

        const xSegs = 25; // Aumentei levemente para melhor detalhe da textura
        const ySegs = 25; 
        const restDistance = 18; 

        let particles = [];
        let constraints = [];
        let clothGeometry;
        let clothMaterial; // Variável global para o material
        let camera, scene, renderer, controls;
        let isDragging = false;
        let mousePos = new THREE.Vector2();
        let raycaster = new THREE.Raycaster();
        let draggedParticle = null;

        // Estado do toque
        let activeMode = 'none';

        // --- Classes de Física ---

        class Particle {
            constructor(x, y, z, mass) {
                this.position = new THREE.Vector3(x, y, z);
                this.previous = new THREE.Vector3(x, y, z);
                this.a = new THREE.Vector3(0, 0, 0); 
                this.invMass = 1 / mass;
                this.tmp = new THREE.Vector3();
            }

            addForce(force) {
                if (this.invMass > 0) this.a.add(force.clone().multiplyScalar(this.invMass));
            }

            integrate(timesq) {
                if (this.invMass === 0) return;
                const newPos = this.tmp.subVectors(this.position, this.previous);
                newPos.multiplyScalar(DAMPING).add(this.position);
                newPos.add(this.a.multiplyScalar(timesq));
                this.previous.copy(this.position);
                this.position.copy(newPos);
                this.a.set(0, 0, 0);
            }
        }

        class Constraint {
            constructor(p1, p2, dist) {
                this.p1 = p1;
                this.p2 = p2;
                this.length = dist;
            }

            satisfy() {
                const diff = new THREE.Vector3().subVectors(this.p2.position, this.p1.position);
                const currentDist = diff.length();
                if (currentDist === 0) return;
                const correction = diff.multiplyScalar(1 - this.length / currentDist);
                const correctionHalf = correction.multiplyScalar(0.5);
                if (this.p1.invMass !== 0) this.p1.position.add(correctionHalf);
                if (this.p2.invMass !== 0) this.p2.position.sub(correctionHalf);
            }
        }

        // --- Inicialização ---

        init();
        setupUI();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0a);

            camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 1, 5000);
            camera.position.set(0, 50, 1100);

            // Iluminação melhorada para texturas
            scene.add(new THREE.AmbientLight(0x666666));
            const spotlight = new THREE.SpotLight(0xffffff, 2000000);
            spotlight.position.set(200, 600, 500);
            spotlight.castShadow = true;
            spotlight.shadow.mapSize.width = 2048;
            spotlight.shadow.mapSize.height = 2048;
            scene.add(spotlight);
            
            // Luz de preenchimento
            const fillLight = new THREE.DirectionalLight(0x444455, 1);
            fillLight.position.set(-200, 200, -200);
            scene.add(fillLight);

            const floorGeo = new THREE.PlaneGeometry(3000, 3000);
            const floorMat = new THREE.MeshPhongMaterial({ color: 0x080808 });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            floor.position.y = -400;
            floor.receiveShadow = true;
            scene.add(floor);

            createCloth();

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            // Configuração importante para cores corretas nas texturas
            renderer.outputColorSpace = THREE.SRGBColorSpace; 
            document.body.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            
            controls.mouseButtons = {
                LEFT: null,
                MIDDLE: THREE.MOUSE.DOLLY,
                RIGHT: THREE.MOUSE.ROTATE
            };
            controls.touches = {
                ONE: null,
                TWO: THREE.TOUCH.DOLLY_PAN
            };

            window.addEventListener('resize', onWindowResize);
            
            renderer.domElement.addEventListener('pointerdown', onPointerDown);
            renderer.domElement.addEventListener('pointermove', onPointerMove);
            window.addEventListener('pointerup', onPointerUp);

            const btnGrab = document.getElementById('btn-grab');
            const btnRotate = document.getElementById('btn-rotate');

            btnGrab.addEventListener('pointerdown', (e) => {
                e.stopPropagation();
                activeMode = 'grab';
                btnGrab.classList.add('active');
                btnRotate.classList.remove('active');
                controls.enabled = false;
            });

            btnRotate.addEventListener('pointerdown', (e) => {
                e.stopPropagation();
                activeMode = 'rotate';
                btnRotate.classList.add('active');
                btnGrab.classList.remove('active');
                controls.enabled = true;
                controls.touches.ONE = THREE.TOUCH.ROTATE;
            });
        }

        function createCloth() {
            // Material global agora acessível para mudanças
            clothMaterial = new THREE.MeshStandardMaterial({
                color: 0x2244ff,
                side: THREE.DoubleSide,
                roughness: 0.5,
                metalness: 0.2,
                map: null
            });

            particles = [];
            constraints = [];
            const index = (u, v) => u + v * (xSegs + 1);

            for (let v = 0; v <= ySegs; v++) {
                for (let u = 0; u <= xSegs; u++) {
                    const p = new Particle(
                        (u - xSegs/2) * restDistance,
                        (ySegs/2 - v) * restDistance + 150,
                        0,
                        MASS
                    );
                    if (v === 0) p.invMass = 0; 
                    particles.push(p);
                }
            }

            for (let v = 0; v <= ySegs; v++) {
                for (let u = 0; u <= xSegs; u++) {
                    if (u < xSegs) constraints.push(new Constraint(particles[index(u, v)], particles[index(u + 1, v)], restDistance));
                    if (v < ySegs) constraints.push(new Constraint(particles[index(u, v)], particles[index(u, v + 1)], restDistance));
                    if (u < xSegs && v < ySegs) {
                        constraints.push(new Constraint(particles[index(u, v)], particles[index(u + 1, v + 1)], restDistance * Math.sqrt(2)));
                        constraints.push(new Constraint(particles[index(u + 1, v)], particles[index(u, v + 1)], restDistance * Math.sqrt(2)));
                    }
                }
            }

            clothGeometry = new THREE.PlaneGeometry(1, 1, xSegs, ySegs);
            const mesh = new THREE.Mesh(clothGeometry, clothMaterial);
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            // Garantir que as sombras fiquem corretas dos dois lados
            mesh.customDepthMaterial = new THREE.MeshDepthMaterial({
                depthPacking: THREE.RGBADepthPacking,
                map: clothMaterial.map,
                alphaTest: 0.5
            });
            scene.add(mesh);
        }

        // --- Lógica da Interface de Configurações ---
        function setupUI() {
            const btnSettings = document.getElementById('btn-settings');
            const panel = document.getElementById('settings-panel');
            const closeBtn = document.getElementById('close-settings');
            const colorPicker = document.getElementById('color-picker');
            const fileInput = document.getElementById('texture-upload');
            const removeTexBtn = document.getElementById('remove-texture');

            // Abrir painel
            btnSettings.addEventListener('click', (e) => {
                e.stopPropagation();
                panel.style.display = 'block';
            });

            // Fechar painel
            closeBtn.addEventListener('click', () => {
                panel.style.display = 'none';
            });

            // Mudar Cor
            colorPicker.addEventListener('input', (e) => {
                clothMaterial.color.set(e.target.value);
            });

            // Upload de Textura
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    const textureLoader = new THREE.TextureLoader();
                    textureLoader.load(event.target.result, (texture) => {
                        // Configurações para a textura ficar bonita
                        texture.colorSpace = THREE.SRGBColorSpace;
                        texture.anisotropy = renderer.capabilities.getMaxAnisotropy();
                        
                        // Aplica ao material
                        clothMaterial.map = texture;
                        clothMaterial.needsUpdate = true;
                        
                        // Se quiser ver a textura pura, setamos a cor para branco, 
                        // senão a cor atual "tinge" a foto. Vamos resetar para branco.
                        clothMaterial.color.setHex(0xffffff);
                        colorPicker.value = "#ffffff";
                        
                        removeTexBtn.style.display = 'block';
                    });
                };
                reader.readAsDataURL(file);
            });

            // Remover Textura
            removeTexBtn.addEventListener('click', () => {
                clothMaterial.map = null;
                clothMaterial.needsUpdate = true;
                clothMaterial.color.setHex(0x2244ff); // Volta para azul padrão
                colorPicker.value = "#2244ff";
                fileInput.value = ""; // Limpa o input
                removeTexBtn.style.display = 'none';
            });
        }

        // --- Funções de Interação (Iguais ao original) ---

        function onPointerDown(event) {
            if (activeMode === 'rotate' || (event.pointerType === 'mouse' && event.button !== 0)) return;
            
            // Impede clique através do painel de configurações
            if (event.target.closest('#settings-panel') || event.target.closest('#btn-settings')) return;

            updateMousePos(event);
            raycaster.setFromCamera(mousePos, camera);
            
            let minDist = Infinity;
            let targetPart = null;

            for (let i = 0; i < particles.length; i++) {
                const p = particles[i];
                const screenPos = p.position.clone().project(camera);
                const dist = mousePos.distanceTo(new THREE.Vector2(screenPos.x, screenPos.y));
                
                if (dist < 0.1) { 
                    const depth = p.position.z;
                    if (depth < minDist) {
                        minDist = depth;
                        targetPart = p;
                    }
                }
            }

            if (targetPart) {
                isDragging = true;
                draggedParticle = targetPart;
                controls.enabled = false;
            }
        }

        function onPointerMove(event) {
            updateMousePos(event);
        }

        function onPointerUp() {
            isDragging = false;
            draggedParticle = null;
            if (activeMode !== 'grab') {
                controls.enabled = true;
            }
        }

        function updateMousePos(event) {
            mousePos.x = (event.clientX / window.innerWidth) * 2 - 1;
            mousePos.y = -(event.clientY / window.innerHeight) * 2 + 1;
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function simulate() {
            const forceGravity = new THREE.Vector3(0, -GRAVITY * MASS, 0);
            for (let p of particles) {
                p.addForce(forceGravity);
                p.integrate(TIMESTEP * TIMESTEP);
            }

            if (isDragging && draggedParticle) {
                raycaster.setFromCamera(mousePos, camera);
                const dragDist = draggedParticle.position.distanceTo(camera.position);
                const rayPoint = new THREE.Vector3();
                raycaster.ray.at(dragDist, rayPoint);
                draggedParticle.position.copy(rayPoint);
                draggedParticle.previous.copy(rayPoint);
            }

            const iterations = 8;
            for (let i = 0; i < iterations; i++) {
                for (let constraint of constraints) {
                    constraint.satisfy();
                }
            }

            for (let p of particles) {
                if (p.position.y < -400) p.position.y = -400;
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            simulate();

            const posAttr = clothGeometry.attributes.position;
            for (let i = 0; i < particles.length; i++) {
                posAttr.setXYZ(i, particles[i].position.x, particles[i].position.y, particles[i].position.z);
            }
            posAttr.needsUpdate = true;
            clothGeometry.computeVertexNormals();

            controls.update();
            renderer.render(scene, camera);
        }

    </script>
</body>
</html>